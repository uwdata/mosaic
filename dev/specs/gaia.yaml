data:
  gaia: |
    -- compute x and y with natural earth projection
    WITH tmp AS (
      SELECT
        radians((-l + 540) % 360 - 180) AS lambda,
        radians(b) AS phi,
        asin(sqrt(3)/2 * sin(phi)) AS t,
        t^2 AS t2,
        t2^3 AS t6,
        *
      FROM 'https://uwdata.github.io/mosaic-datasets/data/gaia-5m.parquet'
    )
    SELECT
      (1.340264 * lambda * cos(t)) / (sqrt(3)/2 * (1.340264 + (-0.081106 * 3 * t2) + (t6 * (0.000893 * 7 + 0.003796 * 9 * t2)))) AS x,
      t * (1.340264 + (-0.081106 * t2) + (t6 * (0.000893 + 0.003796 * t2))) AS y,
      * EXCLUDE('t', 't2', 't6')
    FROM tmp
params:
  brush: { select: crossfilter }
  bandwidth: 0
  binWidth: 2
  scaleType: sqrt
hconcat:
- vconcat:
  - plot:
    - mark: raster
      data: { from: gaia, filterBy: $brush }
      x: x
      y: y
      fill: density
      bandwidth: $bandwidth
      binWidth: $binWidth
    - select: intervalXY
      as: $brush
    domainXY: Fixed
    niceX: false
    niceY: false
    scaleColor: $scaleType
    schemeColor: plasma
    width: 600
    height: 400
    marginLeft: 65
  - hconcat:
    - plot:
      - mark: rectY
        data: { from: gaia, filterBy: $brush }
        x: { bin: phot_g_mean_mag }
        y: { count: }
        fill: steelblue
        inset: 0.5
      - select: intervalX
        as: $brush
      domainX: Fixed
      scaleY: $scaleType
      gridY: true
      width: 300
      height: 200
      marginLeft: 65
    - plot:
      - mark: rectY
        data: { from: gaia, filterBy: $brush }
        x: { bin: parallax }
        y: { count: }
        fill: steelblue
        inset: 0.5
      - select: intervalX
        as: $brush
      domainX: Fixed
      scaleY: $scaleType
      gridY: true
      width: 300
      height: 200
      marginLeft: 65
- hspace: 30
- plot:
  - mark: raster
    data: { from: gaia, filterBy: $brush }
    x: bp_rp
    y: phot_g_mean_mag
    fill: density
    bandwidth: $bandwidth
    binWidth: $binWidth
  - select: intervalXY
    as: $brush
  domainXY: Fixed
  scaleColor: $scaleType
  schemeColor: plasma
  reverseY: true
  width: 400
  height: 600
  marginLeft: 25